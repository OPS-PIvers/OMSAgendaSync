<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <base target="_top">
  <title>Daily Teacher Agendas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
      color: #1f2937;
    }

    /* --- Grade Navigation Tabs --- */
    .grade-nav-container {
      position: relative;
      background-color: #e5e7eb;
      border-radius: 9999px;
      padding: 0.25rem;
      display: flex;
      width: fit-content;
      margin: 0 auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .grade-button {
      position: relative;
      z-index: 10;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      border: none;
      background-color: transparent;
      color: #4b5563;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.3s ease;
      white-space: nowrap;
    }

    .grade-button.active {
      color: #ffffff;
    }
    
    .grade-button:not(.active):hover {
        color: #1f2937;
    }

    #active-grade-pill {
      position: absolute;
      top: 0.25rem;
      bottom: 0.25rem;
      border-radius: 9999px;
      transition: left 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), width 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      z-index: 5;
    }
    
    /* --- Grade Specific Colors --- */
    .bg-grade-6th { background-color: #6366f1; } /* Indigo-500 */
    .bg-grade-7th { background-color: #14b8a6; } /* Teal-500 */
    .bg-grade-8th { background-color: #a855f7; } /* Purple-500 */

    /* --- Smart Card Layout --- */
    .agenda-card {
        background-color: transparent;
        border-radius: 0.75rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        border: 1px solid; /* Border color will be set by JS */
        padding: 1.5rem;
        transition: all 0.3s ease-in-out;
    }

    .card-content-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
    }

    .content-section {
        display: flex;
        flex-direction: column;
    }

    .section-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #9ca3af;
        margin-bottom: 0.25rem;
    }

    .section-text {
        font-size: 0.9rem;
        color: #374151;
        line-height: 1.5;
        max-height: 4.5em; /* Approx 3 lines */
        overflow: hidden;
        text-overflow: ellipsis;
        position: relative;
        transition: max-height 0.3s ease-in-out;
        /* Allow word breaks for long links */
        word-break: break-word;
    }
    
    .agenda-card.expanded .section-text {
        max-height: 500px; /* A large value to allow full expansion */
    }

    .show-more-btn {
        font-size: 0.8rem;
        font-weight: 600;
        color: #4f46e5;
        cursor: pointer;
        margin-top: 0.5rem;
        background: none;
        border: none;
        padding: 0;
        text-align: left;
    }
    
    .show-more-btn:hover {
        text-decoration: underline;
    }

    /* --- Floating Action Buttons (FABs) --- */
    .fab-container {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      display: flex;
      gap: 1rem;
      z-index: 1000;
    }

    .fab-button {
      width: 3.5rem;
      height: 3.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
    }
    .fab-button:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    
    .print-fab { background-color: #3b82f6; } /* Blue-500 */
    .pdf-fab { background-color: #8b5cf6; } /* Violet-500 */
    
    /* --- Skeleton Loader --- */
    .skeleton-row {
        background-color: #ffffff;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .skeleton {
        background-color: #e5e7eb;
        border-radius: 0.5rem;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
        50% { opacity: .5; }
    }

    /* --- Print Styles --- */
    @media print {
      body { background-color: #fff; }
      .no-print { display: none !important; }
      #main-content { padding: 0.5in; }
      .agenda-card {
        box-shadow: none;
        border: 1px solid #ccc !important;
        background-color: #fff !important;
      }
      .section-text {
        max-height: none !important; /* Ensure all text prints */
      }
    }
  </style>
</head>
<body class="antialiased">

  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="text-center mb-8 no-print">
      <div class="flex items-center justify-center gap-4 mb-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">OMS Daily Snapshot</h1>
        <button id="archive-button" class="text-gray-600 hover:text-gray-800 transition-colors" aria-label="View Past Agendas" title="View Past Agendas">
          <i class="fas fa-calendar-alt text-2xl"></i>
        </button>
      </div>
      <div class="flex items-center justify-center gap-2">
        <p id="current-date" class="text-lg text-gray-500"></p>
        <button id="back-to-today" class="hidden px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors">
          Back to Today
        </button>
      </div>
    </header>

    <!-- Grade Level Navigation -->
    <nav class="mb-8 flex justify-center no-print">
      <div id="grade-nav" class="grade-nav-container">
        <div id="active-grade-pill"></div>
        <button class="grade-button" data-grade="6th Grade">6th Grade</button>
        <button class="grade-button" data-grade="7th Grade">7th Grade</button>
        <button class="grade-button" data-grade="8th Grade">8th Grade</button>
      </div>
    </nav>
    
    <!-- Message Area -->
    <div id="message-area" class="text-center text-lg text-gray-700 mb-6" role="status" aria-live="polite"></div>

    <!-- Main Content Area -->
    <main id="main-content">
        <div id="agenda-container" class="space-y-4">
          <!-- Smart Cards will be rendered here -->
        </div>
        
        <div id="loading-container" class="space-y-4">
          <!-- Skeleton loaders will be shown here -->
        </div>
    </main>
  </div>

  <!-- Floating Action Buttons -->
  <div id="fab-container" class="fab-container no-print">
    <button id="print-button" class="fab-button print-fab" aria-label="Print Current View" title="Print View">
      <i class="fas fa-print"></i>
    </button>
    <button id="pdf-button" class="fab-button pdf-fab" aria-label="Save as PDF" title="Save as PDF">
      <i class="fas fa-file-pdf"></i>
    </button>
  </div>

  <!-- PDF Modal -->
  <div id="pdf-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-2000 hidden">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-4xl w-full transform transition-all">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Create Professional PDF</h2>
        <button id="close-modal-button" class="text-gray-500 hover:text-gray-800">&times;</button>
      </div>
      <p class="text-gray-600 mb-6">Select the rows you want to include in your Daily Agenda PDF. Click "Generate PDF" when you're ready.</p>
      <div id="pdf-selection-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto p-4 bg-gray-50 rounded-lg">
        <!-- Checkbox items will be populated here -->
      </div>
      <div class="mt-8 flex justify-end gap-4">
        <button id="cancel-pdf-button" class="px-6 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancel</button>
        <button id="generate-pdf-button" class="px-6 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 flex items-center gap-2">
          <i class="fas fa-file-alt"></i>
          Generate PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Archive Date Selection Modal -->
  <div id="archive-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-2000 hidden">
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full transform transition-all">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Select Archive Date</h2>
        <button id="close-archive-modal-button" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
      </div>
      <p class="text-gray-600 mb-6">Choose a date to view past agenda data:</p>
      <div class="mb-6">
        <label for="archive-date-input" class="block text-sm font-medium text-gray-700 mb-2">Date:</label>
        <input type="date" id="archive-date-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div class="flex justify-end gap-4">
        <button id="cancel-archive-button" class="px-6 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancel</button>
        <button id="view-archive-button" class="px-6 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 flex items-center gap-2">
          <i class="fas fa-calendar-check"></i>
          View Archive
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // --- Global State & DOM Elements ---
    let allAgendaData = [];
    let currentGradeFilter = '6th Grade';
    let isViewingArchive = false;
    let currentArchiveDate = null;

    const agendaContainer = document.getElementById('agenda-container');
    const loadingContainer = document.getElementById('loading-container');
    const messageArea = document.getElementById('message-area');
    const currentDateDisplay = document.getElementById('current-date');
    const gradeNav = document.getElementById('grade-nav');
    const gradeButtons = document.querySelectorAll('.grade-button');
    const activeGradePill = document.getElementById('active-grade-pill');
    const fabContainer = document.getElementById('fab-container');
    const printButton = document.getElementById('print-button');
    const pdfButton = document.getElementById('pdf-button');
    const archiveButton = document.getElementById('archive-button');
    const backToTodayButton = document.getElementById('back-to-today');

    // --- UI Update Functions ---

    function showMessage(msg, type = 'info') {
      messageArea.textContent = msg;
      messageArea.className = 'text-center text-lg text-gray-700 mb-6';
      if (type === 'error') messageArea.classList.add('text-red-600', 'font-semibold');
      else if (type === 'success') messageArea.classList.add('text-green-600');
    }

    function hideMessage() {
      messageArea.textContent = '';
    }
    
    function showLoadingSkeletons(count = 3) {
        agendaContainer.innerHTML = '';
        loadingContainer.innerHTML = '';
        hideMessage();
        for (let i = 0; i < count; i++) {
            const skeleton = `
                <div class="skeleton-row">
                    <div class="skeleton h-6 w-1/2 mb-4"></div>
                    <div class="flex gap-4">
                        <div class="skeleton h-16 w-full"></div>
                        <div class="skeleton h-16 w-full"></div>
                        <div class="skeleton h-16 w-full"></div>
                        <div class="skeleton h-16 w-full"></div>
                    </div>
                </div>
            `;
            loadingContainer.innerHTML += skeleton;
        }
    }

    function hideLoadingSkeletons() {
        loadingContainer.innerHTML = '';
    }

    function updateActiveGradePill(activeButton) {
        const grade = activeButton.dataset.grade;
        const pillColorClass = {
            '6th Grade': 'bg-grade-6th',
            '7th Grade': 'bg-grade-7th',
            '8th Grade': 'bg-grade-8th'
        }[grade];

        activeGradePill.className = 'absolute top-1 bottom-1 rounded-full';
        activeGradePill.classList.add(pillColorClass);
        
        setTimeout(() => {
            activeGradePill.style.left = `${activeButton.offsetLeft}px`;
            activeGradePill.style.width = `${activeButton.offsetWidth}px`;
        }, 0);
    }

    // --- Data Rendering ---
    
    function getSubjectColors(className = '') {
        const name = className.toLowerCase();
        if (name.includes('math') || name.includes('algebra') || name.includes('geometry')) return { headerClass: 'text-blue-800', cardClasses: 'bg-blue-50 border-blue-200' };
        if (name.includes('english') || name.includes('reading') || name.includes('language')) return { headerClass: 'text-red-800', cardClasses: 'bg-red-50 border-red-200' };
        if (name.includes('science')) return { headerClass: 'text-green-800', cardClasses: 'bg-green-50 border-green-200' };
        if (name.includes('social') || name.includes('history') || name.includes('global')) return { headerClass: 'text-yellow-800', cardClasses: 'bg-yellow-50 border-yellow-200' };
        if (name.includes('exploratory') || name.includes('art') || name.includes('music') || name.includes('tech') || name.includes('band') || name.includes('computer') || name.includes('robotics') || name.includes('design') || name.includes('solar') || name.includes('technology') || name.includes('spanish') || name.includes('phy ed') || name.includes('health')) return { headerClass: 'text-purple-800', cardClasses: 'bg-purple-50 border-purple-200' };
        return { headerClass: 'text-gray-800', cardClasses: 'bg-white border-gray-200' };
    }

    function createAgendaCard(agenda) {
        const card = document.createElement('div');
        card.className = 'agenda-card';

        const safeText = (text) => (text || 'N/A').replace(/\n/g, '<br>').replace(/→/g, '<span class="mr-2 text-indigo-500">→</span>');

        const createSection = (label, content) => {
            const section = document.createElement('div');
            section.className = 'content-section';
            
            const textElement = document.createElement('div');
            textElement.className = 'section-text';
            
            // Handle HYPERLINK formulas - first extract all complete HYPERLINK formulas, then process remaining text
            let processedContent = content || 'N/A';
            
            if (typeof processedContent === 'string') {
                // Global regex to find all complete HYPERLINK formulas (including multi-line text)
                const hyperlinkRegex = /=HYPERLINK\("([^"]+)",\s?"((?:[^"]|"")*)"\)/gi;
                const links = [];
                let remainingContent = processedContent;
                let match;
                
                // Extract all HYPERLINK formulas
                while ((match = hyperlinkRegex.exec(processedContent)) !== null) {
                    const url = match[1];
                    const linkText = match[2].replace(/""/g, '"');
                    links.push(`<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${safeText(linkText)}</a>`);
                    // Remove this HYPERLINK formula from remaining content
                    remainingContent = remainingContent.replace(match[0], '').trim();
                }
                
                // Combine processed links with any remaining plain text
                const allContent = [];
                if (links.length > 0) {
                    allContent.push(...links);
                }
                if (remainingContent && remainingContent !== '') {
                    // Split remaining text by newlines and add each non-empty line
                    const remainingLines = remainingContent.split('\n').filter(line => line.trim());
                    remainingLines.forEach(line => allContent.push(safeText(line)));
                }
                
                if (allContent.length > 0) {
                    textElement.innerHTML = allContent.join('<br>');
                } else {
                    textElement.innerHTML = safeText(processedContent);
                }
            } else {
                textElement.innerHTML = safeText(processedContent);
            }

            section.innerHTML = `<h3 class="section-label">${label}</h3>`;
            section.appendChild(textElement);
            
            setTimeout(() => {
                if (textElement.scrollHeight > textElement.clientHeight) {
                    const button = document.createElement('button');
                    button.className = 'show-more-btn';
                    button.textContent = 'Show More';
                    button.onclick = (e) => {
                        e.stopPropagation();
                        const parentCard = e.target.closest('.agenda-card');
                        parentCard.classList.toggle('expanded');
                        e.target.textContent = parentCard.classList.contains('expanded') ? 'Show Less' : 'Show More';
                    };
                    section.appendChild(button);
                }
            }, 100);

            return section;
        };
        
        const contentGrid = document.createElement('div');
        contentGrid.className = 'card-content-grid';

        contentGrid.appendChild(createSection('Turn In', agenda.TurnIn));
        contentGrid.appendChild(createSection('Daily Activities', agenda.Activities));
        contentGrid.appendChild(createSection('Practice / Homework', agenda.PracticeWork));
        contentGrid.appendChild(createSection('Upcoming', agenda.Upcoming));
        
        card.appendChild(contentGrid);
        return card;
    }


    function renderAllContent(gradeFilter) {
      agendaContainer.innerHTML = '';
      hideMessage();

      const filteredData = allAgendaData.filter(item => item.GradeLevel === gradeFilter);
      
      if (filteredData.length === 0) {
        showMessage(`No agendas available for ${gradeFilter} today.`, 'info');
        fabContainer.classList.add('hidden');
        return;
      }

      fabContainer.classList.remove('hidden');
      
      filteredData.forEach(agenda => {
          const itemWrapper = document.createElement('div');
          const colors = getSubjectColors(agenda.ClassName || '');
          
          const header = document.createElement('h2');
          header.className = `text-lg font-bold mb-2 ${colors.headerClass}`;
          const className = agenda.ClassName || 'Class';
          const teacherName = agenda.TeacherLastName || 'Teacher';
          header.innerHTML = `${className} <span class="text-base font-medium text-gray-500">&mdash; ${teacherName}</span>`;
          itemWrapper.appendChild(header);

          const card = createAgendaCard(agenda);
          colors.cardClasses.split(' ').forEach(c => card.classList.add(c));
          itemWrapper.appendChild(card);
          
          agendaContainer.appendChild(itemWrapper);
      });
    }
    
    // --- Data Fetching ---

    async function fetchData(archiveDate = null) {
      showLoadingSkeletons();
      try {
        // This check is for local development vs. Google Apps Script environment
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
           console.warn("Running in local development mode. Using mock data.");
           // Mock data for local testing when not on Google Apps Script
           const mockResponse = [
                { GradeLevel: '6th Grade', ClassName: 'Math 6', TeacherLastName: 'Newton', TurnIn: 'Unit 1 Review', Activities: 'Group work on fractions.', PracticeWork: '=HYPERLINK("https://example.com/math-hw", "Complete worksheet 2.3")', Upcoming: 'Quiz on Friday' },
                { GradeLevel: '6th Grade', ClassName: 'Science 6', TeacherLastName: 'Curie', TurnIn: 'Lab Report', Activities: 'Cell observation under microscope.', PracticeWork: 'Read Chapter 4', Upcoming: 'Project due next week' },
                { GradeLevel: '7th Grade', ClassName: 'English 7', TeacherLastName: 'Austen', TurnIn: 'Essay Draft', Activities: 'Peer review session.', PracticeWork: 'Finalize essay.', Upcoming: 'Book report on "The Giver"' },
            ];
           onSuccess(mockResponse);
           return;
        }
        
        let response;
        if (archiveDate) {
          response = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getArchivedDataForDate(archiveDate);
          });
        } else {
          response = await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(resolve)
              .withFailureHandler(reject)
              .getAgendaData();
          });
        }

        if (response && response.error) {
          throw new Error(response.error);
        }
        
        onSuccess(response);

      } catch (error) {
        onFailure(error);
      }
    }

    function onSuccess(response) {
      hideLoadingSkeletons();
      
      let data = [];
      if (Array.isArray(response)) {
        data = response;
      } else if (response && Array.isArray(response.payload)) {
        data = response.payload;
      } else {
        console.warn('Received data in an unexpected format:', response);
      }

      console.log(`Archive data loaded: ${data.length} records for date: ${currentArchiveDate}`);
      console.log('Data preview:', data.slice(0, 2)); // Log first 2 records for debugging

      allAgendaData = data;
      updateDateDisplay();
      renderAllContent(currentGradeFilter);
    }

    function onFailure(error) {
      hideLoadingSkeletons();
      showMessage(`Error: ${error.message || 'Could not load agendas.'}. Please refresh.`, 'error');
      console.error('Data fetch error:', error);
      fabContainer.classList.add('hidden');
    }

    // --- Date Management ---
    
    function updateDateDisplay() {
      if (isViewingArchive && currentArchiveDate) {
        // Fix timezone issue by forcing local timezone interpretation
        const archiveDate = new Date(currentArchiveDate + "T00:00:00");
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        currentDateDisplay.textContent = `Archive: ${archiveDate.toLocaleDateString('en-US', options)}`;
        backToTodayButton.classList.remove('hidden');
      } else {
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        currentDateDisplay.textContent = today.toLocaleDateString('en-US', options);
        backToTodayButton.classList.add('hidden');
      }
    }
    
    function viewArchiveDate(dateString) {
      console.log(`viewArchiveDate called with: ${dateString}`);
      isViewingArchive = true;
      currentArchiveDate = dateString;
      console.log(`Fetching archive data for: ${dateString}`);
      fetchData(dateString);
    }
    
    function backToToday() {
      isViewingArchive = false;
      currentArchiveDate = null;
      fetchData();
    }

    // --- Print and PDF ---

    function printAgendas() {
      document.querySelectorAll('.agenda-card').forEach(c => c.classList.add('expanded'));
      setTimeout(() => window.print(), 200);
    }

    function populatePdfModal() {
        const selectionContainer = document.getElementById('pdf-selection-container');
        selectionContainer.innerHTML = '';
        const filteredData = allAgendaData.filter(item => item.GradeLevel === currentGradeFilter);

        if (filteredData.length === 0) {
            selectionContainer.innerHTML = '<p class="text-gray-500">No agendas to select for this grade.</p>';
            return;
        }

        filteredData.forEach((agenda, index) => {
            const checkboxId = `pdf-checkbox-${index}`;
            const item = document.createElement('div');
            item.className = 'flex items-center p-3 bg-white rounded-lg shadow-sm';
            item.innerHTML = `
                <input type="checkbox" id="${checkboxId}" data-index="${index}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="${checkboxId}" class="ml-3 text-sm font-medium text-gray-800">
                    <span class="font-bold">${agenda.ClassName}</span> (${agenda.TeacherLastName})
                </label>
            `;
            selectionContainer.appendChild(item);
        });
    }

    // --- PDF GENERATION FUNCTION ---
    function generatePdf() {
        const { jsPDF } = window.jspdf;
        const selectedCheckboxes = document.querySelectorAll('#pdf-selection-container input[type="checkbox"]:checked');
        if (selectedCheckboxes.length === 0) {
            showMessage('Please select at least one agenda item.', 'error');
            return;
        }

        const doc = new jsPDF({ orientation: 'landscape', unit: 'in', format: 'letter' });
        const today = new Date();
        const formattedDate = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const pageMargin = 0.5;
        let cursorY = pageMargin;

        // --- PDF Header ---
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(18);
        doc.text(`Daily Agenda - ${currentGradeFilter}`, pageMargin, cursorY);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.text(formattedDate, doc.internal.pageSize.getWidth() - pageMargin, cursorY, { align: 'right' });
        cursorY += 0.2;
        doc.setDrawColor('#e5e7eb');
        doc.line(pageMargin, cursorY, doc.internal.pageSize.getWidth() - pageMargin, cursorY);
        
        // --- Data Preparation ---
        const filteredData = allAgendaData.filter(item => item.GradeLevel === currentGradeFilter);
        const selectedIndices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index, 10));
        const pdfData = selectedIndices.map(i => filteredData[i]);

        const processCellContent = (content) => {
            if (!content) return 'N/A';
            
            // Extract all complete HYPERLINK formulas first
            const hyperlinkRegex = /=HYPERLINK\("([^"]+)",\s?"((?:[^"]|"")*)"\)/gi;
            const links = [];
            let remainingContent = content;
            let match;
            
            // Find all HYPERLINK formulas
            while ((match = hyperlinkRegex.exec(content)) !== null) {
                const url = match[1];
                const text = match[2].replace(/""/g, '"').replace(/→|!/g, '• ');
                links.push({ text, url });
                // Remove this HYPERLINK formula from remaining content
                remainingContent = remainingContent.replace(match[0], '').trim();
            }
            
            // Process any remaining plain text
            const remainingLines = remainingContent ? 
                remainingContent.split('\n').filter(line => line.trim()).map(line => line.replace(/→|!/g, '• ')) : 
                [];
            
            if (links.length === 1 && remainingLines.length === 0) {
                // Single hyperlink only - return as object for PDF link functionality
                return links[0];
            } else if (links.length > 0 || remainingLines.length > 0) {
                // Multiple items or mix of links and text - return as formatted text
                const allItems = [
                    ...links.map(link => `${link.text} (${link.url})`),
                    ...remainingLines
                ];
                return allItems.join('\n• ');
            }
            
            return content.replace(/→|!/g, '• ');
        };

        const tableData = pdfData.map(agenda => [
            `${agenda.ClassName || 'N/A'}\n${agenda.TeacherLastName || 'N/A'}`,
            processCellContent(agenda.TurnIn),
            processCellContent(agenda.Activities),
            processCellContent(agenda.PracticeWork),
            processCellContent(agenda.Upcoming)
        ]);

        // --- PDF Table Generation ---
        doc.autoTable({
            startY: cursorY + 0.2,
            head: [['Class', 'Turn In', 'Activities', 'Practice', 'Upcoming']],
            body: tableData,
            theme: 'grid',
            margin: { left: pageMargin },
            headStyles: { fillColor: [59, 130, 246] },
            styles: { fontSize: 9, cellPadding: 0.08, valign: 'top', lineColor: [209, 213, 219], lineWidth: 0.01 },
            // *** THIS LINE WAS CORRECTED ***
            columnStyles: { 0: { cellWidth: 1.5 }, 1: { cellWidth: 2 }, 2: { cellWidth: 2.2 }, 3: { cellWidth: 2 }, 4: { cellWidth: 2.2 } },
            
            didParseCell: (data) => {
                if (typeof data.cell.raw === 'object' && data.cell.raw.url) {
                    data.cell.text = [data.cell.raw.text];
                    data.cell.styles.textColor = '#0000FF';
                }
            },

            didDrawCell: (data) => {
                if (typeof data.cell.raw === 'object' && data.cell.raw.url) {
                    doc.link(data.cell.x, data.cell.y, data.cell.width, data.cell.height, { url: data.cell.raw.url });
                }
            }
        });

        doc.save(`Daily_Agenda_${currentGradeFilter.replace(' ', '_')}_${today.toISOString().slice(0,10)}.pdf`);
    }


    // --- Initialization & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
      updateDateDisplay();

      const initialButton = document.querySelector(`.grade-button[data-grade="${currentGradeFilter}"]`);
      if (initialButton) {
        initialButton.classList.add('active');
        updateActiveGradePill(initialButton);
      }

      gradeButtons.forEach(button => {
        button.addEventListener('click', () => {
          currentGradeFilter = button.dataset.grade;
          gradeButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          updateActiveGradePill(button);
          renderAllContent(currentGradeFilter);
        });
      });
    
      window.addEventListener('resize', () => {
          const activeButton = document.querySelector('.grade-button.active');
          if (activeButton) {
              updateActiveGradePill(activeButton);
          }
      });

      printButton.addEventListener('click', printAgendas);
    
      const pdfModal = document.getElementById('pdf-modal');
      const closeModalButton = document.getElementById('close-modal-button');
      const cancelPdfButton = document.getElementById('cancel-pdf-button');
      const generatePdfButton = document.getElementById('generate-pdf-button');

      pdfButton.addEventListener('click', () => {
          populatePdfModal();
          pdfModal.classList.remove('hidden');
      });

      const closeTheModal = () => pdfModal.classList.add('hidden');
      closeModalButton.addEventListener('click', closeTheModal);
      cancelPdfButton.addEventListener('click', closeTheModal);
      
      generatePdfButton.addEventListener('click', () => {
          generatePdf();
          closeTheModal();
      });
      
      // Archive functionality
      const archiveModal = document.getElementById('archive-modal');
      const closeArchiveModalButton = document.getElementById('close-archive-modal-button');
      const cancelArchiveButton = document.getElementById('cancel-archive-button');
      const viewArchiveButton = document.getElementById('view-archive-button');
      const archiveDateInput = document.getElementById('archive-date-input');

      archiveButton.addEventListener('click', () => {
        archiveModal.classList.remove('hidden');
      });

      const closeArchiveModal = () => archiveModal.classList.add('hidden');
      closeArchiveModalButton.addEventListener('click', closeArchiveModal);
      cancelArchiveButton.addEventListener('click', closeArchiveModal);
      
      viewArchiveButton.addEventListener('click', () => {
        const selectedDate = archiveDateInput.value;
        console.log(`Date picker selected: ${selectedDate}`);
        if (selectedDate) {
          console.log(`Date format validation: ${selectedDate} matches YYYY-MM-DD format`);
          viewArchiveDate(selectedDate);
          closeArchiveModal();
        } else {
          showMessage('Please select a date.', 'error');
        }
      });
      
      backToTodayButton.addEventListener('click', backToToday);

      fetchData();
    });
  </script>
</body>
</html>
