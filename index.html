<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- jsPDF and html2canvas for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Font Awesome for collapse/expand icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f3f4f6; /* Light gray background */
    }

    /* Custom Grade Button Colors */
    .bg-grade-6th { background-color: #4f46e5; border-color: #4338ca; } /* Indigo-600, darker border */
    .bg-grade-6th:hover { background-color: #4338ca; } /* Indigo-700 */
    .bg-grade-6th.active { background-color: #f97316; border-color: #ea580c; } /* Orange-500, darker border */

    .bg-grade-7th { background-color: #0d9488; border-color: #0f766e; } /* Teal-600, darker border */
    .bg-grade-7th:hover { background-color: #0f766e; } /* Teal-700 */
    .bg-grade-7th.active { background-color: #f97316; border-color: #ea580c; } /* Orange-500, darker border */

    .bg-grade-8th { background-color: #9333ea; border-color: #7e22ce; } /* Purple-600, darker border */
    .bg-grade-8th:hover { background-color: #7e22ce; } /* Purple-700 */
    .bg-grade-8th.active { background-color: #f97316; border-color: #ea580c; } /* Orange-500, darker border */

    .bg-grade-exploratories { background-color: #e11d48; border-color: #be123c; } /* Rose-600, darker border */
    .bg-grade-exploratories:hover { background-color: #be123c; } /* Rose-700 */
    .bg-grade-exploratories.active { background-color: #f97316; border-color: #ea580c; } /* Orange-500, darker border */

    /* General Button Styling */
    .action-button {
      padding: 0.5rem 1rem; /* Adjusted padding */
      font-size: 0.9rem; /* Adjusted font size */
      border-radius: 0.5rem; /* Adjusted border-radius */
      box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1); /* Softer shadow */
      font-weight: 600;
      transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out, border-color 0.2s ease-in-out;
      border: 1px solid; /* Add a border */
      color: white; /* Ensure text color is white */
      white-space: nowrap; /* Prevent text wrapping inside buttons */
      cursor: pointer;
    }
    .action-button:hover:not(:disabled) { /* Add hover effect */
      filter: brightness(90%); /* Slightly darken on hover */
    }
    .action-button:disabled {
      opacity: 0.6; /* More visible disabled state */
      cursor: not-allowed;
    }
    /* Specific colors for Print/PDF/Confirm/Cancel buttons */
    #print-button { background-color: #059669; border-color: #047857; } /* Emerald-600 */
    #print-button:hover { background-color: #047857; } /* Emerald-700 */
    #pdf-button { background-color: #e11d48; border-color: #be123c; } /* Rose-600 */
    #pdf-button:hover { background-color: #be123c; } /* Rose-700 */
    #confirm-pdf-button { background-color: #4f46e5; border-color: #4338ca; } /* Indigo-600 */
    #confirm-pdf-button:hover { background-color: #4338ca; } /* Indigo-700 */
    #cancel-pdf-button { background-color: #6b7280; border-color: #4b5563; } /* Gray-500 */
    #cancel-pdf-button:hover { background-color: #4b5563; } /* Gray-600 */


    /* Table specific styling */
    .agenda-table {
      width: 100%;
      border-collapse: separate; 
      border-spacing: 0; 
      table-layout: auto; 
      border: 1px solid #e0e7ff; 
      border-radius: 0.75rem; 
      overflow: hidden; 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
    }
    .agenda-table th, .agenda-table td {
      padding: 1.25rem 1.5rem; /* Increased padding for a more spacious look */
      text-align: left;
      border-bottom: 1px solid #e0e7ff; 
      border-right: 1px solid #e0e7ff; 
      vertical-align: top; 
      font-size: 1rem; /* Slightly larger font size for readability */
      line-height: 1.6; 
      color: #374151; 
    }
    .agenda-table th {
      background-color: #eef2ff; 
      font-weight: 600; 
      color: #1c3c7a; 
      white-space: nowrap; 
      text-transform: uppercase; 
      font-size: 0.85rem; /* Slightly larger header font size */
      letter-spacing: 0.05em; 
    }
    /* Remove right border for the last column's cells (excluding checkbox col) */
    .agenda-table th:not(.checkbox-col):last-child,
    .agenda-table td:not(.checkbox-col):last-child {
      border-right: none;
    }
    /* Remove bottom border for the last row's cells */
    .agenda-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* Alternating row colors for better distinction */
    .agenda-table tbody tr:nth-child(odd) {
      background-color: #ffffff; 
    }
    .agenda-table tbody tr:nth-child(even) {
      background-color: #f8fafc; 
    }
    .agenda-table tbody tr:hover {
      background-color: #e0f2fe; 
      transition: background-color 0.2s ease-in-out; 
    }
    
    /* Responsive table for smaller screens */
    @media (max-width: 767px) { 
      .table-responsive {
        overflow-x: auto; 
        -webkit-overflow-scrolling: touch; 
      }
      .agenda-table {
        min-width: 900px; 
      }
      .agenda-table th, .agenda-table td {
        padding: 0.8rem 0.8rem; /* Adjusted padding for smaller screens */
        font-size: 0.9rem; /* Adjusted font size for smaller screens */
      }
    }

    /* Print-specific styles */
    @media print {
      body {
        background-color: #fff;
        margin: 0;
        padding: 0;
        display: block; 
      }
      header, nav, .print-buttons, #message-area, #loading-spinner, .checkbox-col, .toggle-col {
        display: none !important; 
      }
      .container {
        width: 100% !important;
        max-width: none !important;
        padding: 0.5in; 
      }
      .table-responsive {
        overflow-x: visible; 
      }
      .agenda-table {
        min-width: auto; 
        table-layout: auto; 
        border: 1px solid #ccc; 
        box-shadow: none; 
        border-radius: 0; 
      }
      .agenda-table th, .agenda-table td {
        border: 1px solid #ddd; 
        padding: 0.4rem 0.6rem; /* Adjusted padding for print */
        font-size: 0.75rem; /* Adjusted font size for print */
        color: black !important; 
        white-space: normal; 
      }
      .agenda-table th {
        background-color: #e9e9e9; 
        text-transform: none; 
        letter-spacing: normal;
      }
      .agenda-table tbody tr:nth-child(odd) {
        background-color: #ffffff; 
      }
      .agenda-table tbody tr:nth-child(even) {
        background-color: #f0f0f0; 
      }
      /* Ensure content is visible in print */
      .collapsible-content {
        display: block !important;
      }
    }

    /* Collapsible row styles */
    .collapsible-content {
      display: block; /* Default to visible */
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out; /* Smooth transition */
      max-height: 500px; /* Max height when expanded */
    }
    .collapsible-content.collapsed {
      max-height: 0; /* Hide content */
      padding-top: 0 !important; 
      padding-bottom: 0 !important;
    }
    .toggle-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin-left: 0.5rem;
      color: inherit; /* Inherit color from parent */
      font-size: inherit; /* Inherit font size from parent */
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
    }
    .toggle-button:focus {
      outline: 2px solid #2563eb; /* Blue-700 for focus indicator */
      outline-offset: 2px;
    }
    .toggle-icon.rotated {
      transform: rotate(90deg); /* Icon points right when collapsed, down when expanded */
    }

    /* Checkbox column specific styles */
    .checkbox-col {
      width: 1%; 
      text-align: center;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .checkbox-col input[type="checkbox"] {
      transform: scale(1.2); 
      cursor: pointer;
    }
    .checkbox-col.hidden-col {
      display: none;
    }
    .pdf-selection-buttons {
      display: none; 
    }
  </style>
</head>
<body>
  <div class="container mx-auto p-4 md:p-8 flex-grow">
    <!-- Header -->
    <header class="text-center mb-6">
      <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Daily Agendas</h1>
      <p id="current-date" class="text-lg text-gray-600"></p>
    </header>

    <!-- Grade Level Navigation -->
    <nav class="mb-6 flex flex-wrap justify-center gap-3"> 
      <button class="grade-button action-button bg-grade-6th active" data-grade="6th Grade">6th Grade</button>
      <button class="grade-button action-button bg-grade-7th" data-grade="7th Grade">7th Grade</button>
      <button class="grade-button action-button bg-grade-8th" data-grade="8th Grade">8th Grade</button>
      <button class="grade-button action-button bg-grade-exploratories" data-grade="Exploratories">Exploratories</button>
    </nav>

    <!-- Print/PDF Buttons -->
    <div class="print-buttons flex flex-wrap justify-center gap-2 mt-4 mb-4"> 
      <button id="print-button" class="action-button bg-green-600 text-white hover:bg-green-700">Print Current View</button>
      <button id="pdf-button" class="action-button bg-red-600 text-white hover:bg-red-700">Save as PDF</button>
    </div>

    <!-- PDF Selection Buttons (hidden by default) -->
    <div id="pdf-selection-controls" class="pdf-selection-buttons flex flex-wrap justify-center gap-2 mt-4 mb-4"> 
      <button id="confirm-pdf-button" class="action-button bg-blue-600 text-white hover:bg-blue-700">Confirm Selected for PDF</button>
      <button id="cancel-pdf-button" class="action-button bg-gray-400 text-white hover:bg-gray-500">Cancel Selection</button>
    </div>

    <!-- Loading/Error Message -->
    <div id="message-area" class="text-center text-base text-gray-700 mb-4 hidden" role="status" aria-live="polite"></div> 
    <div id="loading-spinner" class="text-center py-8" role="alert" aria-live="assertive">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-blue-700">Loading agendas...</p>
    </div>

    <!-- Agenda Display Area -->
    <div id="agenda-container" class="table-responsive">
      <!-- Agenda table will be rendered here -->
    </div>
  </main>

  <script>
    // Global variable to store all fetched agenda data
    let allAgendaData = [];
    let currentGradeFilter = '6th Grade'; // Default filter
    let pdfSelectionMode = false; // Track if PDF selection mode is active

    // DOM elements
    const agendaContainer = document.getElementById('agenda-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    const messageArea = document.getElementById('message-area');
    const currentDateDisplay = document.getElementById('current-date');
    const gradeButtons = document.querySelectorAll('.grade-button');
    const printButton = document.getElementById('print-button');
    const pdfButton = document.getElementById('pdf-button');
    const pdfSelectionControls = document.getElementById('pdf-selection-controls');
    const confirmPdfButton = document.getElementById('confirm-pdf-button');
    const cancelPdfButton = document.getElementById('cancel-pdf-button');

    // Function to display messages (loading, error, no data)
    function showMessage(msg, type = 'info') {
      messageArea.textContent = msg;
      messageArea.classList.remove('hidden', 'text-red-600', 'text-green-600', 'text-gray-700');
      if (type === 'error') {
        messageArea.classList.add('text-red-600');
      } else if (type === 'success') {
        messageArea.classList.add('text-green-600');
      } else {
        messageArea.classList.add('text-gray-700');
      }
      messageArea.classList.remove('hidden');
    }

    // Function to hide messages
    function hideMessage() {
      messageArea.classList.add('hidden');
    }

    // Function to show/hide loading spinner
    function showLoadingSpinner() {
      loadingSpinner.classList.remove('hidden');
      agendaContainer.innerHTML = ''; // Clear previous content
      hideMessage();
    }

    function hideLoadingSpinner() {
      loadingSpinner.classList.add('hidden');
    }

    // Helper function to convert newlines to <br> tags
    function formatTextWithLineBreaks(text) {
      return text ? text.replace(/\n/g, '<br>') : 'N/A';
    }

    // Function to toggle row content visibility
    function toggleRowDetails(event) {
      const button = event.currentTarget; // The clicked button
      const row = button.closest('tr'); // Find the parent row
      const toggleIcon = button.querySelector('.toggle-icon');
      const collapsibleCells = row.querySelectorAll('.collapsible-content');

      const isExpanded = button.getAttribute('aria-expanded') === 'true';
      button.setAttribute('aria-expanded', String(!isExpanded));

      collapsibleCells.forEach(cellContent => {
        cellContent.classList.toggle('collapsed', isExpanded);
      });
      // Toggle icon rotation: points right when collapsed, down when expanded
      toggleIcon.classList.toggle('rotated', isExpanded); 
    }

    // Function to render agendas based on filter
    function renderAgendas(gradeFilter) {
      agendaContainer.innerHTML = ''; // Clear existing content
      hideMessage();

      const filteredData = allAgendaData.filter(item => item.GradeLevel === gradeFilter);

      if (filteredData.length === 0) {
        showMessage(`No agendas available for ${gradeFilter} today.`, 'info');
        printButton.classList.add('hidden');
        pdfButton.classList.add('hidden');
        return;
      }

      printButton.classList.remove('hidden');
      pdfButton.classList.remove('hidden');

      // Create table structure
      const table = document.createElement('table');
      table.className = 'agenda-table bg-white'; 

      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      // Define headers with their corresponding data keys
      const headersConfig = [
        { text: 'Teacher Last Name', key: 'TeacherLastName', collapsible: false },
        { text: 'Class Name', key: 'ClassName', collapsible: false },
        { text: 'Day of Week', key: 'DayofWeek', collapsible: false },
        { text: 'Turn In', key: 'TopBoxTextTurnin', collapsible: true },
        { text: 'Daily Activities', key: 'MiddleBoxTextDailyActivities', collapsible: true },
        { text: 'Practice Work', key: 'BottomBoxTextPracticeWork', collapsible: true },
        { text: 'Upcoming', key: 'UpcomingText', collapsible: true }
      ];

      // Create table headers
      const headerRow = document.createElement('tr');
      // Add "Select All" checkbox column for PDF selection
      const selectAllTh = document.createElement('th');
      selectAllTh.className = 'checkbox-col hidden-col'; 
      const selectAllCheckbox = document.createElement('input');
      selectAllCheckbox.type = 'checkbox';
      selectAllCheckbox.id = 'select-all-checkbox';
      selectAllCheckbox.addEventListener('change', toggleAllCheckboxes);
      selectAllTh.appendChild(selectAllCheckbox);
      headerRow.appendChild(selectAllTh);

      headersConfig.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header.text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Populate table body with data
      filteredData.forEach((agenda, index) => {
        const tr = document.createElement('tr');
        tr.dataset.index = index; 

        // Array to store IDs of collapsible content for this row
        const collapsibleContentIds = [];

        // Add checkbox column for PDF selection
        const checkboxTd = document.createElement('td');
        checkboxTd.className = 'checkbox-col hidden-col'; 
        const rowCheckbox = document.createElement('input');
        rowCheckbox.type = 'checkbox';
        rowCheckbox.className = 'row-checkbox';
        rowCheckbox.dataset.index = index; 
        checkboxTd.appendChild(rowCheckbox);
        tr.appendChild(checkboxTd);

        headersConfig.forEach(header => {
          const td = document.createElement('td');
          const contentDiv = document.createElement('div');
          contentDiv.innerHTML = formatTextWithLineBreaks(agenda[header.key]);
          
          // Default to open (NO 'collapsed' class initially)
          if (header.collapsible) {
            contentDiv.classList.add('collapsible-content'); 
            const contentId = `agenda-details-${index}-${header.key}`;
            contentDiv.id = contentId;
            collapsibleContentIds.push(contentId);
          }
          td.appendChild(contentDiv);
          tr.appendChild(td);
        });

        // Add toggle button to the Teacher Last Name cell
        const teacherNameCell = tr.querySelector('td:nth-child(2)'); 
        if (teacherNameCell) {
          const toggleButton = document.createElement('button');
          toggleButton.className = 'toggle-button';
          toggleButton.setAttribute('aria-expanded', 'true'); // Default to expanded
          toggleButton.setAttribute('aria-controls', collapsibleContentIds.join(' ')); // Set aria-controls with all IDs
          toggleButton.innerHTML = '<i class="fas fa-chevron-down toggle-icon"></i>'; // Default to down arrow (expanded)
          toggleButton.addEventListener('click', toggleRowDetails);
          teacherNameCell.appendChild(toggleButton); 
          teacherNameCell.style.position = 'relative'; 
          teacherNameCell.style.paddingRight = '2rem'; 
        }
        
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      agendaContainer.appendChild(table);
    }

    // Function to toggle all checkboxes
    function toggleAllCheckboxes(event) {
      const isChecked = event.target.checked;
      document.querySelectorAll('.row-checkbox').forEach(checkbox => {
        checkbox.checked = isChecked;
      });
    }

    // Function to toggle PDF selection mode
    function togglePdfSelectionMode(enable) {
      pdfSelectionMode = enable;

      const checkboxCols = document.querySelectorAll('.checkbox-col');
      const allCheckboxes = document.querySelectorAll('.row-checkbox, #select-all-checkbox');
      const regularButtons = [printButton, pdfButton];
      const pdfControlButtons = [confirmPdfButton, cancelPdfButton];

      if (enable) {
        checkboxCols.forEach(col => col.classList.remove('hidden-col'));
        pdfSelectionControls.style.display = 'flex';
        regularButtons.forEach(btn => btn.disabled = true);
        gradeButtons.forEach(btn => btn.disabled = true); 
        // Ensure all rows are expanded in PDF selection mode for better visibility
        document.querySelectorAll('.collapsible-content').forEach(content => content.classList.remove('collapsed'));
        document.querySelectorAll('.toggle-icon').forEach(icon => icon.classList.remove('rotated')); // Ensure icon is in expanded state
        document.querySelectorAll('.toggle-button').forEach(button => button.setAttribute('aria-expanded', 'true'));
        confirmPdfButton.focus(); // Move focus to the confirm button
      } else {
        checkboxCols.forEach(col => col.classList.add('hidden-col'));
        pdfSelectionControls.style.display = 'none';
        regularButtons.forEach(btn => btn.disabled = false);
        gradeButtons.forEach(btn => btn.disabled = false); 
        allCheckboxes.forEach(cb => cb.checked = false); 
        // Re-set all rows to expanded state (default)
        document.querySelectorAll('.collapsible-content').forEach(content => content.classList.remove('collapsed'));
        document.querySelectorAll('.toggle-icon').forEach(icon => icon.classList.remove('rotated')); // Ensure icon is in expanded state
        document.querySelectorAll('.toggle-button').forEach(button => button.setAttribute('aria-expanded', 'true'));
        pdfButton.focus(); // Return focus to the PDF button 
      }
    }

    // Function to fetch data from Google Apps Script
    async function fetchData() {
      showLoadingSpinner();
      try {
        // This error typically occurs if the web app is opened directly from the Apps Script editor
        // or a local file, instead of its deployed URL.
        if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
          throw new Error("The 'google.script.run' API is not available. Please ensure the web app is deployed and accessed via its provided URL, not directly from the editor.");
        }
        const data = await google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).getAgendaData();
      } catch (error) {
        onFailure(error);
      }
    }

    // Callback for successful data fetch
    function onSuccess(data) {
      hideLoadingSpinner();
      allAgendaData = data; 
      renderAgendas(currentGradeFilter);
    }

    // Callback for failed data fetch
    function onFailure(error) {
      hideLoadingSpinner();
      showMessage(`Error loading agendas: ${error.message}. Please try again later.`, 'error');
      console.error('Error fetching data:', error);
      printButton.classList.add('hidden');
      pdfButton.classList.add('hidden');
    }

    // --- Print and PDF Functions ---

    function printAgendas() {
      window.print();
    }

    async function saveAsPdf() {
      // Enter PDF selection mode
      togglePdfSelectionMode(true);
      showMessage('Select rows for PDF, then click "Confirm Selected for PDF".', 'info');
    }

    async function confirmPdfGeneration() {
      showMessage('Generating PDF...', 'info');
      confirmPdfButton.disabled = true;
      cancelPdfButton.disabled = true;

      try {
        if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') {
          throw new Error("PDF libraries (jsPDF, html2canvas) not loaded.");
        }
        const { jsPDF } = window.jspdf;

        const selectedRows = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                                  .map(cb => parseInt(cb.dataset.index))
                                  .map(index => allAgendaData.filter(item => item.GradeLevel === currentGradeFilter)[index]);

        if (selectedRows.length === 0) {
          showMessage('No rows selected for PDF. Please select at least one.', 'error');
          return; 
        }

        // Create a temporary, hidden div for PDF content
        const pdfContentDiv = document.createElement('div');
        pdfContentDiv.style.cssText = 'position: absolute; left: -9999px; top: -9999px; width: 8.5in; padding: 0.5in; background-color: white;';
        document.body.appendChild(pdfContentDiv);

        // Add a professional header to the PDF content
        pdfContentDiv.innerHTML = `
          <h1 style="font-family: 'Inter', sans-serif; font-size: 24pt; font-weight: bold; text-align: center; color: #1c3c7a; margin-bottom: 20pt;">Daily Agendas - ${currentGradeFilter}</h1>
          <p style="font-family: 'Inter', sans-serif; font-size: 12pt; text-align: center; color: #374151; margin-bottom: 30pt;">Agendas for ${currentDateDisplay.textContent.replace('Agendas for ', '')}</p>
        `;

        // Create a clean table for the PDF content
        const pdfTable = document.createElement('table');
        pdfTable.style.cssText = `
          width: 100%; 
          border-collapse: collapse; 
          font-family: 'Inter', sans-serif; 
          font-size: 10pt;
          border: 1px solid #ccc;
        `;
        const pdfThead = document.createElement('thead');
        const pdfTbody = document.createElement('tbody');

        const pdfHeaders = [
          'Teacher', 'Class', 'Day', 'Turn In', 'Daily Activities', 'Practice Work', 'Upcoming'
        ];
        const pdfHeaderRow = document.createElement('tr');
        pdfHeaders.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          th.style.cssText = `
            padding: 8pt 10pt; 
            text-align: left; 
            background-color: #e9e9e9; 
            font-weight: bold; 
            border: 1px solid #ddd;
            color: black;
          `;
          pdfHeaderRow.appendChild(th);
        });
        pdfThead.appendChild(pdfHeaderRow);
        pdfTable.appendChild(pdfThead);

        selectedRows.forEach((agenda, index) => {
          const tr = document.createElement('tr');
          tr.style.cssText = `background-color: ${index % 2 === 0 ? '#ffffff' : '#f0f0f0'};`; // Alternating rows
          tr.innerHTML = `
            <td style="padding: 8pt 10pt; border: 1px solid #ddd; vertical-align: top;">${agenda.TeacherLastName || 'N/A'}</td>
            <td style="padding: 8pt 10pt; border: 1px solid #ddd; vertical-align: top;">${agenda.ClassName || 'N/A'}</td>
            <td style="padding: 8pt 10pt; border: 1px solid #ddd; vertical-align: top;">${agenda.DayofWeek || 'N/A'}</td>
            <td style="padding: 8pt 10pt; border: 1px solid #ddd; vertical-align: top;">${formatTextWithLineBreaks(agenda.TopBoxTextTurnin)}</td>
            <td style="padding: 8pt 10pt; border: 1px solid #ddd; vertical-align: top;">${formatTextWithLineBreaks(agenda.MiddleBoxTextDailyActivities)}</td>
            <td style="padding: 8pt 10pt; border: 1px solid #ddd; vertical-align: top;">${formatTextWithLineBreaks(agenda.BottomBoxTextPracticeWork)}</td>
            <td style="padding: 8pt 10pt; border: 1px solid #ddd; vertical-align: top;">${formatTextWithLineBreaks(agenda.UpcomingText)}</td>
          `;
          pdfTbody.appendChild(tr);
        });
        pdfTable.appendChild(pdfTbody);
        pdfContentDiv.appendChild(pdfTable);

        // Generate PDF from the temporary div
        const canvas = await html2canvas(pdfContentDiv, {
          scale: 2, 
          useCORS: true,
          logging: false 
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'pt', 'letter'); 

        const imgWidth = 612; 
        const pageHeight = 792; 
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        const today = new Date();
        const dateString = today.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
        const filename = `DailyAgendas_Selected_${currentGradeFilter.replace(/\s/g, '')}_${dateString}.pdf`;

        pdf.save(filename);
        showMessage('PDF generated successfully!', 'success');

      } catch (error) {
        showMessage(`Error generating PDF: ${error.message}.`, 'error');
        console.error('PDF generation error:', error);
      } finally {
        // Clean up temporary div
        if (pdfContentDiv && pdfContentDiv.parentNode) {
          pdfContentDiv.parentNode.removeChild(pdfContentDiv);
        }
        // Exit PDF selection mode
        togglePdfSelectionMode(false);
        confirmPdfButton.disabled = false;
        cancelPdfButton.disabled = false;
      }
    }

    // Event listeners for grade buttons
    gradeButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Exit PDF selection mode if active
        if (pdfSelectionMode) {
          togglePdfSelectionMode(false);
        }
        gradeButtons.forEach(btn => {
          btn.classList.remove('active');
          btn.removeAttribute('aria-current');
        });
        button.classList.add('active');
        button.setAttribute('aria-current', 'page');
        
        currentGradeFilter = button.dataset.grade;
        renderAgendas(currentGradeFilter);
      });
    });

    // Event listeners for print and PDF buttons
    printButton.addEventListener('click', printAgendas);
    pdfButton.addEventListener('click', saveAsPdf);
    confirmPdfButton.addEventListener('click', confirmPdfGeneration);
    cancelPdfButton.addEventListener('click', () => togglePdfSelectionMode(false));


    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      currentDateDisplay.textContent = `Agendas for ${today.toLocaleDateString('en-US', options)}`;

      document.querySelector(`.grade-button[data-grade="${currentGradeFilter}"]`).classList.add('active');

      fetchData();
    });
  </script>
</body>
</html>
